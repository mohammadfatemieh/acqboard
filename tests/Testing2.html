<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Soma Acq Board Testingg</title>
</head>
<body>
<span style="font-weight: bold; text-decoration: underline;">11 March
2006</span>: Acqboard 01<br
 style="font-weight: bold; text-decoration: underline;">
<br>
Detailed test and assembly log for Acqboard 01: Digital side<br>
<span style="font-weight: bold;"><br>
</span>
<ol>
  <li><span style="font-weight: bold;">First, we solder up the digital
power</span></li>
  <li><span style="font-weight: bold;">Solder QFp, etc</span></li>
  <li><span style="font-weight: bold;">All back-of-board bypass caps
are 0.1 uF Caps</span></li>
</ol>
Everyting soldered and documented; now try programming -- worked. <br>
<br>
<span style="font-weight: bold; font-style: italic;">Now the analog
side -- first isolators, then the power supply <br>
<br>
Analog references appear to work properly. <br>
<br>
We had to use non-recently-purchased 150 uf Caps, 311-1071-1-ND,
CC0603JRNP09BN151 from digikey. <br>
<br>
</span><span style="font-weight: bold;"><span
 style="text-decoration: underline;">13 March 2006<br>
<br>
</span></span>Informal performance measurements of the ADC + AA look
correct. Soldering on registers and the other hardware for further
measurement.&nbsp; <br>
<br>
With the ADCs, AAs, and PGAs, but without any earlier-stage muxes, and
with the inputs all ganged together, we get :<br>
<br>
<br>
Now, we solder on : <br>
1. the rest of the channel's bypass caps<br>
2. The Mux and amp<br>
3. the 5.6k Resistor<br>
4. <span style="font-style: italic;"><span style="font-weight: bold;">We
ordered the wrong 68nF caps, so we're jusing 490-3360-1-ND, a 1206 COG.
<br>
<br>
<br>
</span></span><span
 style="text-decoration: underline; font-weight: bold;">14 March 2006<br>
</span><span style="font-style: italic;"><span
 style="font-weight: bold;"><span style="font-style: italic;"><br>
</span></span></span><span style="font-weight: bold;"></span><span
 style="font-style: italic;"><span style="font-weight: bold;">Our
results are as follows for the boards which have everything but the IN-A<br>
<br>
<img alt=""
 src="results/20060313/just_adc_aa_pga.A1.noshortedinputs.png"
 style="width: 600px; height: 450px;"><br>
<br>
<br>
<span style="font-weight: bold;"><span style="font-style: italic;">This
is confusing and unfortunate. </span></span></span><span
 style="font-style: italic;"><span style="text-decoration: underline;"><br>
<br>
<span style="text-decoration: underline;"></span></span></span></span>Further
refinement along the analysis end has show that, for high gains using
the LPF, we end up with awful nonlinearities. <br>
<br>
Below is the difference over serveral cycles between the recorded sine
and the fit sine for a gain of 5 with the HPF enabled. <br>
<br>
<img alt="" src="results/20060314/hpf_minus_model.png"
 style="width: 1200px; height: 900px;"><br>
<span style="text-decoration: underline;"><span
 style="font-style: italic;"></span></span><span
 style="font-style: italic;"><span style="font-style: italic;"><span
 style="text-decoration: underline;"></span></span><span
 style="font-weight: bold;"><span style="font-weight: bold;"><span
 style="font-style: italic;"></span></span>I don't know what this is. <br>
<br>
Resoldering the Mux appears to have fixed the problem: <br>
<br>
</span></span>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060314/All.A1.png" style="width: 400px; height: 300px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060314/All.B1.png" style="width: 400px; height: 300px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
    </tr>
  </tbody>
</table>
<span style="font-style: italic;"><span style="font-weight: bold;"><br>
</span></span><span
 style="text-decoration: underline; font-weight: bold;">15 March 2006</span><br
 style="text-decoration: underline; font-weight: bold;">
Now we try with the in-amps, AD8221AR. We use ERJ-3EKF1004V
(P1.00MHCT-ND) resistors, 1 MOhm, and 1 uf Caps. <br>
<br>
Things looked great, but now we're seeing a ton of non-HPF THD+N
variance. To measure this, I've removed the mux and am just directly
measuring the HPF-less signal chain. <br>
<br>
Here is B1 initially, with an entire signal chain: <br>
<img alt="" src="results/20060315/B1.g100.pre-test.png"
 style="width: 600px; height: 450px;"><br>
<br>
It looks great. The associated data is at B1.good.h5.&nbsp; (note this
is with segnum = 100) <br>
<br>
If we want we can seriously overdrive the ADC -- -1.8V to 4.2V! <br>
<br>
This doesn't appear to cause any noticable difference, however, in the
measured response. <br>
<br>
Cleaned off the flux, now let's look... no real difference. <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">16 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
Trying hard to be more rigorous here. It's not even obvious what we're
measuring or how/why we should care. To that effect, I think that the
current plots are not very useful/effective. <br>
<br>
<span style="font-weight: bold;">test.70.h5</span>: Both channels A1
and B1 soldered; A1 Ac-coupling caps removed; using All-Chan connector.
<br>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">17 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
We continue, even after substantial refactoring of sine-fitting code,
to get unfortunate-looking results. <br>
<br>
As a test, first thing in the morning, we will record: Both channels A1
and B1 soldered; A1 Ac-coupling caps removed; using All-Chan connector.
<br>
<br>
<br>
<img alt="" src="results/20060317/early.B1.png"
 style="width: 600px; height: 450px;"><br>
Note that, contrary to what the graph says, the signals with high
variance actually have the HPF -off-. I don't think what results is a
problem with sine convergence, because we clearly have results
-converging-, and there is a very clear difference between the HPF
off-and-on states. This data is in early.B1.h5. <br>
<br>
<br>
Test Plans -- to develop comprehensive testing, we're going to record
noise data and sine data across HPF and LPF. <br>
<br>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">18 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
I think it's more important to try and characterize the nature of our
observed problem: <br>
1. Is it real ? <br>
2. why does it vary with segment size? <br>
3. What is the spectral relation? <br>
<br>
Here, we have the results of B1, gain = 100, hpf = 0, sine, a few
sines. <br>
<br>
<img alt="" src="results/20060318/B1.original.gain100.hpf0.THDn.png"
 style="width: 600px; height: 716px;"><br>
<br>
<br>
THD+N for various frequencies across a series of frequencies. <br>
<br>
There is more low-frequency noise in the hpf=off, so it makes sense
that fitting over smaller windows would be tighter. <br>
<br>
I'm going to try filtering the data and then seeing what we get. <br>
<br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060318/B1.original.gain100-hpf1.thdns.png"
 style="width: 400px; height: 300px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060318/B1.original.gain100-hpf0.thdns.png"
 style="width: 400px; height: 300px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060318/B1.original.gain100-hpf0-filtered.thdns.png"
 style="width: 400px; height: 300px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">THD+N across multiple segment
sizes for 2.6k, gain = 100, with HPF on <br>
      </td>
      <td style="vertical-align: top;">THD+N across multiple segment
sizes for 2.6k, gain = 100, with HPF on </td>
      <td style="vertical-align: top;">THD+N across multiple segment
sizes for 2.6k, gain = 100, with HPF on, filtered with <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Note that when we (digitally) filter, we get a much flatter response
(minus the edges, an artifact of filtering). And notice that the same
thing happens when we reduce the segment size. My best conclusion is
that we have some low-freqency noise (surprise!) that gets filtered out
by the HPF, and that causes the problems we see in the LPF. <br>
<br>
Given this, I think that the best future option will be fitting to
short records. In addition, we will now specify our ns in terms of
segment lengths. <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">19 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
We need to robustly measure noise, and come up with a way of saving
that data to the files that also have sine data. <br>
<br>
Ultimately, we're interested in absolute noise at various gains. <br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060319/A1.noise.png"
 style="width: 600px; height: 450px;"></td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060319/B1.noise.png"
 style="width: 600px; height: 450px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Noise for A1<br>
      </td>
      <td style="vertical-align: top;">Noise for B1<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
The channels start off with roughly the same amount of noise at G=100,
but the noise stays flat across gains whereas B1 decreases. <br>
<br>
This would seem to suggest ... A1 has some intrinsic noise, whereas
with B1 the noise is ADC-dominated? <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">20 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
Using the shorter THD+N windows, we get:<br>
<img alt="" src="results/20060320/A1.allthdn.png"
 style="width: 1024px; height: 972px;"><br>
This would be fine except that we have really bad performance now on
B1. <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">21 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
At this point, A1 is the normal looking channel and B1, g=10k, hpf=off
looks horrible. <br>
<br>
We'll try power-cycling... no effect; now we'll try input B. No effect.
What the hell happened? <br>
<br>
So, to diagnose this we have removed the input AC-coupling network, and
the 10 uF Coupling capacitor: <br>
<br>
<img alt="" src="results/20060321/A1-B1.noise.justAA+ADC.png"
 style="width: 1200px; height: 900px;"><br>
<br>
<br>
&nbsp;<br>
<span style="font-style: italic;"><br>
We get a graph that looks almost exactly like this when we remove the
In-Amp and ground the input to the PGA/HPF subcircuit. <br>
<br>
</span><span style="font-weight: bold; text-decoration: underline;">22
March 2006</span><br
 style="font-weight: bold; text-decoration: underline;">
<span style="font-style: italic;"><span style="font-style: italic;"></span></span>TWe
soldered on A3 and B3, without any part of the spike filter (HPF
network -- no mux, no filter, no cap, etc.) and we get the following:<br>
<br>
<img alt="" src="results/20060322/A1-B1-A3-B3-noise.png"
 style="width: 600px; height: 490px;"><br>
That is, A1 still has the bad performance, but all other channels
appear to have ADC-dominated noise . <br>
<br>
Accidentally ran against the noise tests, so we no doubt had some
sustained periods of overvoltage. Let's see if that actually kills our
THD+N. <br>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">23 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
The THD+N we measure for these channels <span
 style="font-weight: bold;">which lack the HPF circuitry or AC-coupling
is:</span><br>
<br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060323/A3.withoutHPF.THD+N.png"
 style="width: 500px; height: 375px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060323/B3.withoutHPF.THD+N.png"
 style="width: 500px; height: 375px;"><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
111, 112 are new with AC-coupling:<br>
<br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060323/A3.with-AC-coupling.THD+N.png"
 style="width: 600px; height: 450px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060323/B3.with-AC-coupling.THD+N.png"
 style="width: 600px; height: 450px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Wow, A3 looks like total shit. But noise measurements show that A3 and
B3 still have good noise performance. <br>
<br>
Now, to check, we'll replace the AC-coupling components on A3 with just
the zero-ohm resistor -- we clearly get the same A3 as above. <br>
<br>
What is up with the upper side of the board? We've removed mux and HPF
amp from A1, and resoldered AC-coupling r/c on A3, and will test again
-- we still get the same poor non-flat response for A3:<br>
<img alt="" src="results/20060323/A3.with-AC-coupling.THD+N.2.png"
 style="width: 400px; height: 300px;"><br>
<br>
<br>
<br>
<br>
Now, with a different XLR-connector board (one which also provides
input to A1's current no-AC-coupling In-amp) we get something that
looks virtually identical. <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">24 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
As best I can tell, an artifact of adding the AC-coupling components is
to generate very-low-frequency artifacts which impact THD+N. <br>
<br>
Let's try with 1M/1uf vs 100k/10uF:<br>
<br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060324/A3.1M1uF.png"
 style="width: 600px; height: 450px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060324/A3.100k10uF.png"
 style="width: 600px; height: 450px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">1 MOhm, 1 uF<br>
      </td>
      <td style="vertical-align: top;">100k, 10 uF<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Now, let's measure our noise perf: <br>
<br>
<img alt="" src="results/20060324/A3.noise.png"
 style="width: 600px; height: 450px;"><br>
<br>
<br>
The B3 channel shows exactly the same performance when we substitute
resistors like this. <br>
<br>
Now, we add on other resistors and use the multiple-input selection;
what happens when the input is loaded down by multiple resistors? We
don't really care, but...<br>
<br>
Now, we've soldered onto A3 and B3 the HPF-amp and the mux, but not the
R/C; now let's measure: <br>
<br>
<br>
&nbsp;<br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060324/A3.all.png" style="width: 500px; height: 381px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060324/B3.all.png" style="width: 500px; height: 403px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
As near as we can tell, the above are complete channels. <br>
<br>
<big><big><span style="font-weight: bold; text-decoration: underline;">Oh
my, there are horrible systemic errors in all of the previous NOISE
MEASUREMENTS. </span><br
 style="font-weight: bold; text-decoration: underline;">
<br>
</big></big><span style="font-weight: bold; text-decoration: underline;">25
March 2006</span><br
 style="font-weight: bold; text-decoration: underline;">
Let's try and measure noise properly now...<br>
<img alt="" src="results/20060325/A3B3.noise.png"
 style="width: 600px; height: 450px;"><br>
<br>
<br>
<br>
Okay, that looks pretty awesome. <br>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">27 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
Looking at the results after a few days, and a board cleaning:&nbsp;
Looks fine. A3 and B3 have good THD+N. <br>
<br>
<span style="font-weight: bold; text-decoration: underline;">29 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
All of the channels that use the old HPF caps have the strange THD+N
curves; the current ones don't. It is very possible that <code>490-3360-1-ND
is the solution to our problems on that front. <br>
<br>
Noise performance looks great across all channels -except- for A1,
which has its long-standing problems. <br>
<br>
</code><br>
<br>
<span style="font-weight: bold; text-decoration: underline;">31 March
2006</span><br style="font-weight: bold; text-decoration: underline;">
<br>
So here we are: <br>
<table style="width: 100%; text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060331/B1.thdn.png" style="width: 300px; height: 225px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060331/B2.thdn.png" style="width: 300px; height: 225px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060331/B3.thdn.png" style="width: 300px; height: 225px;"><br>
      </td>
      <td style="vertical-align: top;"><img alt=""
 src="results/20060331/B4.thdn.png" style="width: 300px; height: 225px;"><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Apparently a large part of the crappy results arose from our choice of
the HPF cap -- the answer appears to be GRM31C5C1H683JA01L, or Digikey
490-3360-1-ND. <br>
<br>
<span style="font-weight: bold;">WE've confirmed that the noise in a
neuralynx amp at g=400 = 5.7 uV RMS, and g=40000 are 3.9 uV RMS. <br>
<br>
SOldering up A1, we note that the AD8510ARMs in the box are marked
differently from the ones in our package. We are using the box one for
A1. <br>
<br>
Still, performance on A 1 looks great. <br>
<br>
<br>
<img alt="" src="results/20060331/noise.png"
 style="width: 1000px; height: 700px;"><br>
</span><span style="font-style: italic;"><br>
<br>
Noise performance. Woohoo, spring break! <br>
<br style="font-weight: bold;">
</span><br style="font-weight: bold; text-decoration: underline;">
<span style="font-weight: bold; text-decoration: underline;"></span><span
 style="font-weight: bold; text-decoration: underline;">1 April 2006</span><span
 style="font-weight: bold;"><br>
<br>
<span style="font-weight: bold;"></span></span>There exist many
situations where csinlesq will return one result and pysinlesq will
return another, and this is very frustrating; sometimes these differ by
as much as 90 dB! It seems that all the poor-THD+N results were
essentially artifacts. <br>
<br>
<span style="font-weight: bold;"><span style="font-weight: bold;"></span>Also,
simply shorting A1 and AC doesn't appear to negatively impact either;
now we'll try with in-muxes<br>
<br>
</span><span style="text-decoration: underline; font-weight: bold;">2
April 2006</span><br
 style="text-decoration: underline; font-weight: bold;">
<span style="font-weight: bold;"><span style="font-weight: bold;">Un</span></span>fortunately,
the performance on the inmux channels looks awful.<br>
<img alt="" src="results/20060402/AC.bad.thdn.png"
 style="width: 600px; height: 450px;">&nbsp;<br>
<br>
I think this is a direct result of the large voltage swing encountering
the non-flat RON; to test this, I'm going to replace the AC HPF with a
zero-ohm resistor and then remove the PGAIN pin. Thus the input to the
mux (U9) will be through a AD8510 ARM buffer. <br>
<br>
<span style="text-decoration: underline; font-weight: bold;">3 April
2006</span><br style="text-decoration: underline; font-weight: bold;">
<span style="font-weight: bold;"><br>
I think we're ready to go. </span>Although oh my, I may have been
calculating noise wrong this entire time!<br>
<br>
<img alt="" src="results/20060403/noise.correct.png"
 style="width: 1000px; height: 736px;"><br>
<br>
<br>
<br>
<span style="font-weight: bold;"><br>
</span><span style="font-weight: bold; font-style: italic;"></span>
</body>
</html>
